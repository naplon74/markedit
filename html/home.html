<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home</title>
  <link rel="stylesheet" href="../node_modules/@fortawesome/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="../css/home.css">
  <script>
    // Load theme before page renders
    const currentTheme = localStorage.getItem('theme') || 'dark';
    const themeLink = document.createElement('link');
    themeLink.rel = 'stylesheet';
    themeLink.href = `../themes/${currentTheme}.css`;
    themeLink.dataset.theme = currentTheme;
    document.head.appendChild(themeLink);
  </script>
</head>
<body>
  <div class="home-container">
    <!-- Custom Title Bar -->
    <div class="custom-titlebar">
      <div class="titlebar-left">
        <button class="titlebar-button" id="menu-btn" title="Settings">
          <i class="fas fa-bars"></i>
        </button>
        <button class="titlebar-button" id="home-btn">
          <i class="fas fa-home"></i>
        </button>
      </div>
      <div class="titlebar-right">
        <button class="window-button" id="minimize-btn">
          <i class="fas fa-window-minimize"></i>
        </button>
        <button class="window-button" id="maximize-btn">
          <i class="fas fa-window-maximize"></i>
        </button>
        <button class="window-button close" id="close-btn">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- Home Content -->
    <div class="home-content">
      <!-- Update Notification -->
      <div class="update-notification" id="update-notification">
        <div class="update-notification-header">
          <i class="fas fa-download update-icon"></i>
          <h3 class="update-title" id="update-title">Update Available</h3>
        </div>
        <p class="update-message" id="update-message">A new version is available and will be downloaded in the background.</p>
        <div class="update-progress" id="update-progress">
          <div class="update-progress-bar" id="update-progress-bar"></div>
        </div>
        <div class="update-actions" id="update-actions">
          <button class="update-btn secondary" id="update-dismiss">Later</button>
        </div>
      </div>

      <div class="welcome-section">
        <h1 class="welcome-title" id="welcome-text" data-i18n="home_welcome">Welcome back!</h1>
        <p class="welcome-subtitle" data-i18n="home_subtitle">Continue where you left off or start something new</p>
      </div>

      <button class="new-file-button" id="new-file-btn">
        <i class="fas fa-plus"></i>
        <span data-i18n="new_file">New File</span>
      </button>

      <div class="import-dropzone" id="import-dropzone" style="display:none;">
        <div class="drop-inner">
          <i class="fas fa-file-import"></i>
          <div class="drop-title">Drag & drop a .md file to import</div>
          <div class="drop-sub">You can also drop .markdown or .txt files</div>
        </div>
      </div>

      <h2 class="section-title" data-i18n="recent_files">Recent Files</h2>
      <div class="files-grid" id="files-grid">
        <div class="empty-state">
          <div class="empty-state-icon">ðŸ“„</div>
          <div class="empty-state-text" data-i18n="empty_state">No files yet. Create your first markdown file!</div>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/dialog.js"></script>
  <script src="../js/i18n.js"></script>
  <script>
    const { ipcRenderer } = require('electron');

    // Window controls
    document.getElementById('minimize-btn').addEventListener('click', () => {
      ipcRenderer.send('minimize-window');
    });

    document.getElementById('maximize-btn').addEventListener('click', () => {
      ipcRenderer.send('maximize-window');
    });

    document.getElementById('close-btn').addEventListener('click', () => {
      ipcRenderer.send('close-window');
    });

    // Handle close request from main process
    ipcRenderer.on('request-close', () => {
      // No unsaved changes on home page, just close
      ipcRenderer.send('confirm-close');
    });

    // Burger opens settings directly
    const menuBtn = document.getElementById('menu-btn');
    menuBtn.addEventListener('click', () => {
      try { localStorage.setItem('returnTo', JSON.stringify({ page: 'home' })); } catch {}
      ipcRenderer.send('load-page', 'settings.html');
    });

    // Home button
    document.getElementById('home-btn').addEventListener('click', () => {
      ipcRenderer.send('load-page', 'home.html');
    });

    // New file button
    document.getElementById('new-file-btn').addEventListener('click', async () => {
      const fileData = await ipcRenderer.invoke('create-new-file');
      if (fileData) {
        localStorage.setItem('currentFileId', fileData.id);
        ipcRenderer.send('load-page', 'editor.html');
      }
    });

    // Drag & drop import zone (entire home-content)
    const homeContent = document.querySelector('.home-content');
    if (homeContent) {
      const isValidExt = (name) => /\.(md|markdown|txt)$/i.test(name);
      let dragCounter = 0; // Track nested drag events
      
      homeContent.addEventListener('dragenter', (e) => {
        e.preventDefault();
        dragCounter++;
        if (dragCounter === 1) homeContent.classList.add('drag-active');
      });
      
      homeContent.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dragCounter--;
        if (dragCounter === 0) homeContent.classList.remove('drag-active');
      });
      
      homeContent.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
      });
      
      homeContent.addEventListener('drop', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragCounter = 0;
        homeContent.classList.remove('drag-active');
        
        // Electron provides file paths in dataTransfer.files[i].path
        // But we need to access them differently in the renderer
        const files = Array.from(e.dataTransfer.files);
        if (!files || !files.length) return;
        
        const file = files[0];
        if (!isValidExt(file.name)) {
          dialog.alert('Invalid File', 'Please drop a .md, .markdown or .txt file.');
          return;
        }
        
        try {
          // Read the file using FileReader and send content to main process
          const reader = new FileReader();
          reader.onload = async (ev) => {
            try {
              const content = ev.target.result;
              const fileName = file.name.replace(/\.(md|markdown|txt)$/i, '');
              
              // Create new file with the content
              const fileData = await ipcRenderer.invoke('create-new-file');
              if (fileData) {
                fileData.title = fileName;
                fileData.content = content;
                await ipcRenderer.invoke('save-file', fileData);
                localStorage.setItem('currentFileId', fileData.id);
                ipcRenderer.send('load-page', 'editor.html');
              }
            } catch (err) {
              dialog.alert('Import Failed', err?.message || String(err));
            }
          };
          reader.onerror = () => {
            dialog.alert('Import Failed', 'Could not read file.');
          };
          reader.readAsText(file);
        } catch (err) {
          dialog.alert('Import Failed', err?.message || String(err));
        }
      });
    }

    // Load user data
    async function loadUserData() {
      const settings = await ipcRenderer.invoke('get-settings');
      const welcomeText = document.getElementById('welcome-text');
      
      if (settings && settings.username) {
        // Get the translated base text if i18n is ready, otherwise use default
        const base = (window.i18n && window.i18n.currentLanguage) ? i18n.t('home_welcome') : 'Welcome back';
        // Set the text directly without data-i18n to prevent override
        welcomeText.textContent = `${base}, ${settings.username}!`;
        // Remove data-i18n attribute so i18n doesn't overwrite it
        welcomeText.removeAttribute('data-i18n');
      }

      const recentFiles = await ipcRenderer.invoke('get-recent-files');
      displayRecentFiles(recentFiles);
    }

    // Display recent files
    function displayRecentFiles(files) {
      const filesGrid = document.getElementById('files-grid');
      
      if (files.length === 0) {
        filesGrid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"><i class="far fa-file-alt"></i></div>
            <div class="empty-state-text">No files yet. Create your first markdown file!</div>
          </div>
        `;
        return;
      }

      filesGrid.innerHTML = files.map(file => `
        <div class="file-card" data-file-id="${file.id}">
          <button class="file-menu-btn" data-file-id="${file.id}" data-file-title="${file.title}">
            <i class="fas fa-ellipsis-v"></i>
          </button>
          <div class="file-card-menu" data-file-id="${file.id}">
            <div class="file-card-menu-item rename-file" data-file-id="${file.id}" data-file-title="${file.title}">
              <i class="fas fa-edit"></i> ${window.i18n ? i18n.t('rename') : 'Rename'}
            </div>
            <div class="file-card-menu-item danger delete-file" data-file-id="${file.id}" data-file-title="${file.title}">
              <i class="fas fa-trash"></i> ${window.i18n ? i18n.t('delete') : 'Delete'}
            </div>
          </div>
          <div class="file-title">${file.title}</div>
          <div class="file-preview">${file.preview || 'Empty file'}</div>
          <div class="file-meta">Modified ${formatDate(file.lastModified)}</div>
        </div>
      `).join('');

      // Add click handlers for file cards
      document.querySelectorAll('.file-card').forEach(card => {
        card.addEventListener('click', (e) => {
          // Don't open if clicking menu button or menu items
          if (e.target.closest('.file-menu-btn') || e.target.closest('.file-card-menu')) {
            return;
          }
          const fileId = card.getAttribute('data-file-id');
          localStorage.setItem('currentFileId', fileId);
          ipcRenderer.send('load-page', 'editor.html');
        });
      });

      // Add menu toggle handlers
      document.querySelectorAll('.file-menu-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const fileId = btn.getAttribute('data-file-id');
          const menu = document.querySelector(`.file-card-menu[data-file-id="${fileId}"]`);
          
          // Close all other menus
          document.querySelectorAll('.file-card-menu').forEach(m => {
            if (m !== menu) m.classList.remove('show');
          });
          
          menu.classList.toggle('show');
        });
      });

      // Add rename handlers
      document.querySelectorAll('.rename-file').forEach(item => {
        item.addEventListener('click', async (e) => {
          e.stopPropagation();
          const fileId = item.getAttribute('data-file-id');
          const currentTitle = item.getAttribute('data-file-title');
          
          // Close menu
          document.querySelector(`.file-card-menu[data-file-id="${fileId}"]`).classList.remove('show');
          
          const result = await dialog.prompt('Rename File', 'Enter new name for the file:', currentTitle, 'File name');
          
          if (result.action === 'ok' && result.inputValue.trim()) {
            const success = await ipcRenderer.invoke('rename-file', fileId, result.inputValue.trim());
            if (success) {
              loadUserData(); // Refresh the file list
            }
          }
        });
      });

      // Add delete handlers
      document.querySelectorAll('.delete-file').forEach(item => {
        item.addEventListener('click', async (e) => {
          e.stopPropagation();
          const fileId = item.getAttribute('data-file-id');
          const fileTitle = item.getAttribute('data-file-title');
          
          // Close menu
          document.querySelector(`.file-card-menu[data-file-id="${fileId}"]`).classList.remove('show');
          
          const result = await dialog.confirmDelete(fileTitle);
          
          if (result.action === 'delete') {
            const success = await ipcRenderer.invoke('delete-file', fileId);
            if (success) {
              loadUserData(); // Refresh the file list
            }
          }
        });
      });

      // Close menus when clicking outside
      document.addEventListener('click', () => {
        document.querySelectorAll('.file-card-menu').forEach(menu => {
          menu.classList.remove('show');
        });
      });
    }

    // Format date
    function formatDate(date) {
      const d = new Date(date);
      const now = new Date();
      const diffMs = now - d;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins} min ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
      
      return d.toLocaleDateString();
    }

    // Initialize
    ipcRenderer.send('rpc-set-home');
    
    // Initialize translations first, then load user data
    if (window.i18n) {
      i18n.init().then(() => {
        loadUserData();
      }).catch(e => {
        console.warn('i18n init failed:', e);
        loadUserData(); // Load anyway if i18n fails
      });
    } else {
      loadUserData();
    }

    // =================== Auto Update Handling ===================
    const updateNotification = document.getElementById('update-notification');
    const updateTitle = document.getElementById('update-title');
    const updateMessage = document.getElementById('update-message');
    const updateProgress = document.getElementById('update-progress');
    const updateProgressBar = document.getElementById('update-progress-bar');
    const updateActions = document.getElementById('update-actions');
    const updateDismiss = document.getElementById('update-dismiss');

    let updateInfo = null;

    // Dismiss notification
    updateDismiss?.addEventListener('click', () => {
      updateNotification.classList.remove('show');
    });

    // Update available
    ipcRenderer.on('update-available', (_e, info) => {
      updateInfo = info;
      updateTitle.textContent = `Update Available: v${info?.version || ''}`;
      updateMessage.textContent = 'A new version is being downloaded in the background.';
      updateNotification.classList.add('show');
      updateProgress.classList.remove('show');
      updateActions.innerHTML = ''; // No buttons during download
    });

    // Download progress
    ipcRenderer.on('download-progress', (_e, progress) => {
      const percent = Math.floor(progress?.percent || 0);
      updateProgress.classList.add('show');
      updateProgressBar.style.width = `${percent}%`;
      updateMessage.textContent = `Downloading update: ${percent}%`;
    });

    // Update downloaded
    ipcRenderer.on('update-downloaded', (_e, info) => {
      updateTitle.textContent = 'Update Ready to Install';
      updateMessage.textContent = `Version ${info?.version || ''} has been downloaded. Restart to install.`;
      updateProgress.classList.remove('show');
      updateActions.innerHTML = `
        <button class="update-btn primary" id="update-restart">Restart Now</button>
        <button class="update-btn secondary" id="update-later">Later</button>
      `;

      document.getElementById('update-restart')?.addEventListener('click', () => {
        ipcRenderer.send('quit-and-install');
      });

      document.getElementById('update-later')?.addEventListener('click', () => {
        updateNotification.classList.remove('show');
      });
    });

    // Update not available (silent - no notification)
    ipcRenderer.on('update-not-available', () => {
      // Do nothing - no update banner needed
    });

    // Update error (silent in production, just log)
    ipcRenderer.on('update-error', (_e, err) => {
      console.warn('Update check error:', err?.message || err);
      // Don't show error to user unless it's critical
    });
  </script>
</body>
</html>
